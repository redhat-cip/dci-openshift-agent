- name: "dci-openshift-agent : Mirror images"
  vars:
    image_name: "{{ image | regex_replace('^[^/]*/', '') }}"
    local_registry: "{{ local_registry_host }}:{{ local_registry_port }}"
    local_image_location: "{{ local_registry }}/{{ image_name }}"
  block:
    - name: "Mirror image {{ image_name }}"
      command:
        cmd: >
          skopeo copy
          --remove-signatures
          --authfile {{ dci_pullsecret_file }}
          --dest-tls-verify=false
          docker://{{ image }}
          docker://{{ local_image_location }}
      register: skopeo_copy
      retries: 5
      delay: 5
      until:
        - skopeo_copy is not failed

  rescue:
    - name: "Rescue: If image {{ image_name }} is already mirrored"
      command: >
        skopeo inspect
        --tls-verify=false
        docker://{{ local_image_location }}
      register: mg_inspect
      failed_when: mg_inspect.rc != 0
...

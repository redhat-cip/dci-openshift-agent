---
- name: set EXTERNAL_SUBNET
  set_fact:
    extcidrnet: "{{ ip | ipaddr('network') }}/{{ ip | ipaddr('prefix') }}"
  vars:
    ip: "{{ ansible_default_ipv4.address }}/{{ ansible_default_ipv4.netmask }}"

- name: Get version and build from localhost vars
  set_fact:
    version: "{{ hostvars.localhost.version }}"
    build: "{{ hostvars.localhost.build }}"

- name: Get pullsecret from localhost vars
  set_fact:
    pullsecret: "{{ hostvars.localhost.pullsecret| to_json }}"
  no_log: true

- name: Populate clusterosimage from fetch_bits
  set_fact:
    clusterosimage: "{{ hostvars.localhost.clusterosimage }}"
  when: hostvars.localhost.clusterosimage is defined

- name: Populate bootstraposimage from fetch_bits
  set_fact:
    bootstraposimage: "{{ hostvars.localhost.bootstraposimage }}"
  when: hostvars.localhost.bootstraposimage is defined

- import_role:
    name: node-prep

- import_role:
    name: installer

- name: "Check the master nodes managed by MCP are updated and ready"
  k8s_info:
    kind: MachineConfigPool
    name: master
  register: mcp_master
  retries: 240
  delay: 10
  until:
    - "'resources' in mcp_master"
    - "mcp_master.resources|length == 1"
    - "'status' in mcp_master.resources[0]"
    - "mcp_master.resources[0].status.readyMachineCount == mcp_master.resources[0].status.machineCount"
    - "mcp_master.resources[0].status.updatedMachineCount == mcp_master.resources[0].status.machineCount"

- name: "Check the worker nodes managed by MCP are updated and ready"
  k8s_info:
    kind: MachineConfigPool
    name: worker
  register: mcp_worker
  retries: 300
  delay: 10
  until:
    - "'resources' in mcp_worker"
    - "mcp_worker.resources|length == 1"
    - "'status' in mcp_worker.resources[0]"
    - "mcp_worker.resources[0].status.readyMachineCount == mcp_worker.resources[0].status.machineCount"
    - "mcp_worker.resources[0].status.updatedMachineCount == mcp_worker.resources[0].status.machineCount"

- name: "dci-openshift-agent : Setup openshift access"
  include_role:
    name: oc-setup
    apply:
      delegate_to: localhost

- name: "dci-openshift-agent : Prepare cluster for CNF"
  include_role:
    name: prepare-cnf
    apply:
      delegate_to: localhost
  when:
    - hostvars.localhost.dci_prepare_cnf|bool

- name: "dci-openshift-agent : Install performance profile operator"
  include_role:
    name: operator-performance-profile
    apply:
      delegate_to: localhost
  when:
    - hostvars.localhost.enable_perf_addon|default(true)|bool
    - hostvars.localhost.dci_prepare_cnf|bool

- name: "dci-openshift-agent : Install sriov operator"
  include_role:
    name: operator-sriov
    apply:
      delegate_to: localhost
  when:
    - hostvars.localhost.enable_sriov|default(true)|bool
    - hostvars.localhost.dci_prepare_cnf|bool

- name: Reset maxUnavailable count to default value 1
  # environment:
  #   KUBECONFIG: "{{ dci_cluster_configs_dir }}/kubeconfig"
  command:
    cmd: oc patch mcp worker --type=merge -p '{"spec":{"maxUnavailable":1}}'
  when:
    - hostvars.localhost.enable_perf_addon|default(true)|bool
    - hostvars.localhost.enable_sriov|default(true)|bool
    - hostvars.localhost.dci_prepare_cnf|bool
  delegate_to: localhost

- name: "dci-openshift-agent : Setup podman on the jumphost"
  include_role:
    name: podman-setup
    apply:
      delegate_to: localhost

- name: "dci-openshift-agent : Side-load podman images prior to testing"
  include_role:
    name: image-side-load
    apply:
      delegate_to: localhost
...
